# Тестовое задание S7  

## Суть задания

Необходимо разработать сервис, для разбора входящего csv файла в директорию и базу данных.

## Требования

Каждые 2 минуты (+- 30сек) в папку 'In' файловой системы поступает файл в формате csv, все поля обязательные имя файла в формате '20221129_1234_DME.csv' - '<год><месяц><день>_<номер рейса>_<аэропорт вылета>.csv'
При появлении файла (Приложение 1) в папке нужно преобразовать файл в формат json (Приложение 2) и сохранить его в папке 'Out'. Исходный файл переместить в папку 'Ok'. В случае возникновения ошибок файл переместить в папку 'Err'. Успешно обработанные файлы поместить в таблицу 'flight'(Приложение 3) базы данных SQLite (или другую на выбор). 

## Дополнительные требования
1.	Процессы сохранения файла в папку и в БД желательно сделать параллельными.
2.	Базу данных и таблицу flight создать при первом запуске программы
3.	Все действия сервиса должны выводиться в лог
4.	Реализовать REST API метод для выборки всех рейсов из таблицы flight за определённую дату
5.	Ответить на вопрос: каким образом можно ускорить запрос на выборку данных, при большом объеме данных.

### Приложение 1. Пример входящего csv-файла
num;surname;firstname;bdate  
1;IVANOV;IVAN;11NOV73  
2;PETROV;ALEXANDER;13JUL79  
3;BOSHIROV;RUSLAN;12APR78  

### Приложение 2. Формат данных в json
 
+ "date" (строка дата в формате ISO),  
+ "flt" (число),  
+ "dep" (строка) необходимо взять из имени файла  
+ "prl" - список словарей, содержимое csv файла  
`{
    "flt": 1234,
    "date": "2020-11-29",
    "dep": "DME",
    "prl": [
        {
            "num": "1",
            "surname": "IVANOV",
            "firstname": "IVAN",
            "bdate": "1973-11-11"
        },
        {
            "num": "2",
            "surname": "PETROV",
            "firstname": "ALEXANDER",
            "bdate": "1979-07-13"
        },
        {
            "num": "3",
            "surname": "BOSHIROV",
            "firstname": "RUSLAN",
            "bdate": "1978-04-12"
        }
    ]
}`

### Приложение 3. Структура таблицы flight
  id INTEGER PRIMARY KEY AUTOINCREMENT,  
  file_name TEXT NOT NULL, – имя полученого файла  
  flt INTEGER NOT NULL,  --номер рейса  
  depdate DATE NOT NULL, --дата рейса  
  dep TEXT NOT NULL --аэропорт вылета  


## Установка

Клонируем проект  

    $ pip git clone https://github.com/hotredchilipepper/test_s7.git 
    
Для создания виртуального окружения   

Win:  

    $ python -m venv name  
Linux:  

    $ python3 -m venv name  
    
Активировать виртуальное окружение командой  

Win:  

    $ .\venv\Scripts\activate  
    
Linux:  

    $ source venv/bin/activate  
    
Переходим в директорию проекта  

    $ cd test_s7  
    
Для обновления модулей программы  

Win:  

    $ pip install --upgrade pip  
    
Linux:  

    $ pip3 install --upgrade pip  

Установка зависимостей нужных для работы программы  

Win:  

    $ pip install -r requirements.txt  
    
Linux:  

    $ pip3 install -r requirements.txt  

#### После успешной установки всех зависимостей, остается запустить приложения.
1. Под Windows я запускал их в разных терминалах командами:
    
    `python main.py`
    
    `uvicorn rest_api:app --reload`
   
2. Под Linux к примеру на сервере приложения можно запустить в консольной утилите tmux в разных терминалах:

    2.1. Краткое руководство по работе в tmux по [ссылке](https://habr.com/ru/post/327630/)

    2.2 Создать два терминала и так же запустить приложения командами:

    `python3 main.p` 

    `uvicorn rest_api:app --reload`
    
3. В браузере перейти по адресу http://127.0.0.1:8000/docs где для будет представлено REST API с документацией.


